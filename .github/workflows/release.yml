name: Release

on:
  workflow_dispatch:
    inputs:
      increment:
        description: 'Version increment'
        required: true
        default: 'minor'
        type: choice
        options:
          - major
          - minor
          - patch
          - beta

jobs:
  release:
    runs-on: ubuntu-latest
    outputs:
      next_version: ${{ steps.next_version.outputs.next_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Get current version
        id: get_version
        run: |
          VERSION=$(grep -E '^techdebt[[:space:]]*=' gradle/libs.versions.toml | sed -E 's/.*=[[:space:]]*"(.*)"/\1/')
          echo "current_version=$VERSION" >> $GITHUB_OUTPUT

      - name: Calculate next version
        id: next_version
        run: |
          CURRENT_VERSION=${{ steps.get_version.outputs.current_version }}
          INCREMENT=${{ github.event.inputs.increment }}
          echo "Current version: $CURRENT_VERSION"
          echo "Increment: $INCREMENT"
          
          # Remove beta suffix if exists for base calculation
          BASE_VERSION=$(echo $CURRENT_VERSION | cut -d'-' -f1)
          MAJOR=$(echo $BASE_VERSION | cut -d'.' -f1)
          MINOR=$(echo $BASE_VERSION | cut -d'.' -f2)
          PATCH=$(echo $BASE_VERSION | cut -d'.' -f3)
          
          if [ "$INCREMENT" == "major" ]; then
            NEXT_VERSION="$((MAJOR + 1)).0.0"
          elif [ "$INCREMENT" == "minor" ]; then
            NEXT_VERSION="${MAJOR}.$((MINOR + 1)).0"
          elif [ "$INCREMENT" == "patch" ]; then
            # If current version is a beta, patch stays the same but it becomes stable
            # Example: 1.2.4-beta01 -> patch -> 1.2.4
            if [[ $CURRENT_VERSION == *"-beta"* ]]; then
              NEXT_VERSION="${MAJOR}.${MINOR}.${PATCH}"
            else
              NEXT_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))"
            fi
          elif [ "$INCREMENT" == "beta" ]; then
            # If current version is already a beta, increment the beta number
            if [[ $CURRENT_VERSION == *"-beta"* ]]; then
              BETA_PART=$(echo $CURRENT_VERSION | cut -d'-' -f2)
              BETA_NUMBER=$(echo $BETA_PART | sed 's/beta0*//')
              NEXT_BETA_NUMBER=$((BETA_NUMBER + 1))
              # Format with leading zero
              NEXT_BETA_NUMBER=$(printf "%02d" $NEXT_BETA_NUMBER)
              NEXT_VERSION="${MAJOR}.${MINOR}.${PATCH}-beta${NEXT_BETA_NUMBER}"
            else
              # If current is stable, increment minor and start beta01
              NEXT_MINOR="$((MINOR + 1))"
              NEXT_VERSION="${MAJOR}.${NEXT_MINOR}.0-beta01"
            fi
          fi
          
          echo "Next version: $NEXT_VERSION"
          echo "next_version=$NEXT_VERSION" >> $GITHUB_OUTPUT

      - name: Commit and push
        id: commit
        run: |
          NEXT_VERSION=${{ steps.next_version.outputs.next_version }}
          sed -i "s/^techdebt[[:space:]]*=[[:space:]]*\".*\"/techdebt = \"$NEXT_VERSION\"/" gradle/libs.versions.toml

          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add gradle/libs.versions.toml
          git commit -m "Bump version to $NEXT_VERSION"
          git pull --rebase origin main

          NEW_TAG="v$NEXT_VERSION"
          git tag $NEW_TAG
          git push origin main --tags

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.next_version.outputs.next_version }}
          name: ${{ steps.next_version.outputs.next_version }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}

  publish:
    runs-on: macos-latest
    needs: release
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: v${{ needs.release.outputs.next_version }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Publish to Maven Central
        run: ./gradlew publishToMavenCentral --stacktrace
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.SIGNING_SECRET_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.SIGNING_PASSWORD }}
